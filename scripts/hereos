#!/usr/bin/env python

import getopt, sys, yaml, io

def usage():
		"""Print usage information"""
		print "Welcome to the HereOS SDK"
		print ""
		print "Usage: hereos [--help|-h|--version|-v] [COMMAND]"
		print "\tinit\tInitializes a new HereOS project in the current working directory"
		print "\tlist-services\tShows a list of available microsservices and their installation status"
		print "\tenable-service <service_name>\tAdds a microservice to the current project's build"
		print "\tcreate-service <service_name>\tCreates a new microservice template and adds it to the build"
		print "\tdisable-service <service_name>\tRemoves a microservice from the current project's build"
		print "\tbuild\tBuilds a device image"
		print "\tdeploy\tDeploys the built image to the current device (if OTA is enabled)"
		print ""


def version():
		"""Print the version string"""
		print "HereOS Version: 0.0.1\n"

def list_services():
		"""Print a list of available SDK services"""
		print "Available microservices in the HereOS SDK:\n"
		for service in yaml.load(io.open("config/services.yaml", "r")):
				print "\t%s\t%s" % (service["name"], service["description"])
		print ""

def main():
		"""Main entry point for CLI"""
		if len(sys.argv) == 1:
				usage()
				sys.exit()

		# Process option arguments
		try:
				opts, args = getopt.getopt(sys.argv[1:], "hv", ["help", "version"])
		except getopt.GetoptError as err:
				# print help information and exit:
				print str(err)
				usage()
				sys.exit(2)
		for o, a in opts:
				if o in ("-v", "--version"):
						version()
						sys.exit()
	 			elif o in ("-h", "--help"):
						usage()
						sys.exit()
				elif o in ("-l", "--list-services"):
						list_services()
						sys.exit()
				else:
						assert False, "unhandled option"

		# Switch on main command
		try:
				{
						'list-services': lambda x: list_services(),
				}[args[0]](args[1:])
		except KeyError:
				print "Unknown command: '%s'\n" % args[0]
				usage()
				sys.exit(2)

if __name__ == "__main__":
		main()

# vim: tabstop=4 shiftwidth=4 noexpandtab

